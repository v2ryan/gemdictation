<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…ç´šè½å¯«ç‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            touch-action: manipulation; /* Improves touch response on iPad */
        }
        .blob {
            position: absolute;
            filter: blur(40px);
            z-index: -1;
            opacity: 0.4;
            animation: move 10s infinite alternate;
        }
        @keyframes move {
            from { transform: translate(0, 0) scale(1); }
            to { transform: translate(20px, -20px) scale(1.1); }
        }
        input[type=range] {
            height: 25px;
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 30px;
            width: 30px;
            border-radius: 50%;
            background: #3b82f6;
            margin-top: -10px;
            box-shadow: 1px 1px 5px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 10px;
            cursor: pointer;
            background: #dbeafe;
            border-radius: 5px;
        }
        .kid-btn {
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .kid-btn:active {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Custom Checkbox */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        /* History Item Styling */
        .history-item {
            transition: all 0.2s;
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Modal Animation */
        #confirm-modal-content {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<!-- Ensure overflow-y-auto is present for scrolling -->
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-y-auto pb-20">

    <!-- Background Blobs -->
    <div class="blob bg-pink-300 w-64 h-64 rounded-full top-0 left-0"></div>
    <div class="blob bg-yellow-200 w-72 h-72 rounded-full bottom-0 right-0"></div>
    <div class="blob bg-blue-200 w-48 h-48 rounded-full top-1/2 left-1/2"></div>

    <!-- Main Container -->
    <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl w-full max-w-2xl p-6 border-4 border-blue-100 relative z-10 my-4">
        
        <!-- Header -->
        <header class="text-center mb-6 relative">
            <h1 class="text-4xl font-black text-blue-600 tracking-tight">ğŸ“ è¶…ç´šè½å¯«ç‹</h1>
            <p class="text-gray-500 font-bold mt-1">å°ˆå¿ƒè½ï¼Œæ…¢æ…¢å¯«ï¼</p>
            <button onclick="showHistory()" class="absolute top-0 right-0 p-2 text-blue-400 hover:text-blue-600 transition-colors flex flex-col items-center" title="æ­·å²ç´€éŒ„">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-bold">ç´€éŒ„</span>
            </button>
        </header>

        <!-- Setup Section -->
        <div id="setup-panel" class="space-y-6">
            
            <!-- Instructions Box -->
            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 text-sm text-yellow-800">
                <h3 class="font-black text-lg mb-2">ğŸ’¡ æ€æ¨£ä½¿ç”¨ï¼Ÿ</h3>
                <ul class="list-disc pl-5 space-y-1">
                    <li>åœ¨ä¸‹æ–¹æ ¼å­è¼¸å…¥è¦é»˜æ›¸çš„å­—ï¼Œ<span class="font-bold text-red-500">æ¯ä¸€é¡Œè«‹æ›ä¸€è¡Œ (æŒ‰ Enter)</span>ã€‚</li>
                    <li>å¦‚æœæ˜¯è‹±æ–‡å¥å­ï¼Œå¯ä»¥ç›´æ¥è¼¸å…¥ (ä¾‹å¦‚: <i>Apple is red.</i>)ï¼Œç¨‹å¼æœƒæ•´å¥è®€å‡ºã€‚</li>
                    <li>æŒ‰ã€Œé–‹å§‹è½å¯«ã€å¾Œï¼Œæœƒå¾ç¬¬ä¸€é¡Œé–‹å§‹è®€ã€‚</li>
                </ul>
            </div>

            <!-- Word Input -->
            <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100 relative">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-blue-800 font-bold text-lg">1. è½å¯«å…§å®¹ (Words)</label>
                    
                    <button onclick="clearInput()" class="text-red-400 hover:text-red-600 font-bold text-sm px-2 flex items-center gap-1" title="æ¸…ç©ºæ‰€æœ‰æ–‡å­—">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        æ¸…ç©º
                    </button>
                </div>

                <textarea id="word-input" class="w-full h-48 p-4 rounded-xl border-2 border-blue-200 focus:border-blue-500 focus:outline-none text-xl resize-none leading-relaxed text-gray-900 font-medium">è˜‹æœ
é¦™è•‰
Today is Monday.
I like apples, bananas and oranges.</textarea>
                <p class="text-xs text-gray-500 mt-2 text-right">è¨˜å¾—æŒ‰ Enter æ›è¡Œä¾†åˆ†éš”æ¯ä¸€é¡Œ</p>
            </div>

            <!-- Settings Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                <!-- Language -->
                <div class="bg-purple-50 p-4 rounded-2xl border-2 border-purple-100">
                    <label class="block text-purple-800 font-bold mb-2">2. é¸æ“‡èªè¨€</label>
                    <div class="relative">
                        <select id="language-select" class="w-full p-3 rounded-xl border-2 border-purple-200 bg-white font-bold text-gray-700 text-lg focus:outline-none">
                            <option value="zh-HK">ğŸ‡­ğŸ‡° å»£æ±è©± (Cantonese)</option>
                            <option value="en-US">ğŸ‡ºğŸ‡¸ è‹±æ–‡ (English US)</option>
                            <option value="en-GB">ğŸ‡¬ğŸ‡§ è‹±æ–‡ (English UK)</option>
                        </select>
                    </div>
                </div>

                <!-- Speed -->
                <div class="bg-green-50 p-4 rounded-2xl border-2 border-green-100">
                    <label class="block text-green-800 font-bold mb-2">3. æœ—è®€é€Ÿåº¦</label>
                    <input type="range" id="speed-range" min="0.5" max="1.2" step="0.1" value="0.8">
                    <div class="flex justify-between text-xs font-bold text-green-600 mt-1">
                        <span>æ…¢ååçƒé¾œ ğŸ¢</span>
                        <span>å¿«å¿…å…”å­ ğŸ‡</span>
                    </div>
                </div>

                <!-- Options: Read Punctuation -->
                <div class="bg-orange-50 p-4 rounded-2xl border-2 border-orange-100 md:col-span-2">
                    <div class="flex items-center justify-between">
                        <label class="text-orange-800 font-bold flex flex-col">
                            <span>4. è®€å‡ºæ¨™é»ç¬¦è™Ÿï¼Ÿ</span>
                            <span class="text-xs text-orange-600 font-normal">è®€å‡º "é€—è™Ÿ"ã€"å¥è™Ÿ"ã€"å•è™Ÿ" ç­‰</span>
                        </label>
                        
                        <!-- Toggle Switch -->
                        <div class="relative inline-block w-14 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="read-punctuation" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 left-0 transition-all duration-300"/>
                            <label for="read-punctuation" class="toggle-label block overflow-hidden h-8 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Start Button -->
            <button onclick="startDictation()" class="kid-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-black text-2xl py-4 rounded-2xl shadow-lg border-b-4 border-blue-700 tracking-wider">
                é–‹å§‹è½å¯« â–¶
            </button>
        </div>

        <!-- Active Mode -->
        <div id="active-panel" class="hidden text-center py-8">
            <div class="mb-8">
                <span class="inline-block bg-blue-100 text-blue-600 font-black px-4 py-2 rounded-full text-sm tracking-wide">
                    è½å¯«é€²è¡Œä¸­... åŠ æ²¹ï¼
                </span>
            </div>

            <!-- Progress Display -->
            <div class="relative w-48 h-48 mx-auto mb-8 flex items-center justify-center bg-blue-50 rounded-full border-8 border-blue-200">
                <div>
                    <div class="text-gray-400 font-bold text-lg mb-1">ç¬¬</div>
                    <div id="word-counter" class="text-6xl font-black text-blue-600">1</div>
                    <div class="text-gray-400 font-bold text-lg mt-1">é¡Œ / å…± <span id="total-words">10</span> é¡Œ</div>
                </div>
            </div>

            <!-- Current Action Status -->
            <p id="status-text" class="text-2xl font-bold text-gray-600 mb-8 min-h-[1.5em]">æº–å‚™å¥½äº†å—ï¼Ÿ</p>

            <!-- Controls -->
            <div class="flex gap-4 justify-center">
                <button onclick="repeatWord()" class="kid-btn flex-1 bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-4 rounded-2xl border-b-4 border-yellow-600 text-xl">
                    ğŸ”„ å†è®€ä¸€æ¬¡
                </button>
                <button id="next-btn" onclick="nextWord()" class="kid-btn flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-2xl border-b-4 border-green-700 text-xl">
                    ä¸‹ä¸€é¡Œ â¡
                </button>
            </div>
            
            <button onclick="stopDictation()" class="mt-8 text-red-400 font-bold hover:text-red-600 underline">
                åœæ­¢åŠè¿”å›
            </button>
        </div>

        <!-- Finished Screen -->
        <div id="finished-panel" class="hidden text-center py-10">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h2 class="text-3xl font-black text-blue-600 mb-2">å¤ªæ£’äº†ï¼</h2>
            <p class="text-gray-500 font-bold mb-8">ä½ å·²ç¶“å®Œæˆäº†æ‰€æœ‰é¡Œç›®ã€‚</p>
            <button onclick="stopDictation()" class="kid-btn bg-purple-500 hover:bg-purple-600 text-white font-black py-3 px-8 rounded-2xl border-b-4 border-purple-700 text-xl">
                å†åšä¸€æ¬¡ï¼Ÿ
            </button>
        </div>

        <!-- History Panel (Improved GUI) -->
        <div id="history-panel" class="hidden absolute inset-0 bg-white z-50 flex flex-col p-6 rounded-3xl">
            <div class="flex justify-between items-center mb-6 border-b-2 border-blue-100 pb-4">
                <h2 class="text-3xl font-black text-blue-600 flex items-center gap-2">
                    <span>ğŸ“œ</span> æ­·å²ç´€éŒ„
                </h2>
                <button onclick="showSetup()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <p class="text-gray-500 mb-4 text-sm font-bold">é»æ“Šã€Œè¤‡ç¿’ã€ä¾†é‡æ–°è¼‰å…¥ä¹‹å‰çš„å…§å®¹ã€‚</p>
            
            <div id="history-list" class="flex-1 overflow-y-auto space-y-4 pr-2">
                <!-- History Items will be injected here -->
            </div>
            
            <button onclick="clearHistory()" class="mt-4 text-red-400 font-bold text-sm hover:text-red-600 self-center">
                æ¸…é™¤æ‰€æœ‰ç´€éŒ„
            </button>
        </div>

        <!-- Custom Confirmation Modal (Replaces browser confirm) -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div id="confirm-modal-content" class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl">
                <h3 id="confirm-title" class="text-2xl font-black text-gray-800 mb-2">ç¢ºå®šå—ï¼Ÿ</h3>
                <p id="confirm-msg" class="text-gray-500 font-bold mb-6">æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex gap-3">
                    <button onclick="closeConfirmModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
                        å–æ¶ˆ (Cancel)
                    </button>
                    <button onclick="onConfirmYes()" class="flex-1 py-3 rounded-xl font-black text-white bg-red-500 hover:bg-red-600 shadow-md transition-colors">
                        ç¢ºå®š (Yes)
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Notification/Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full opacity-0 transition-opacity pointer-events-none font-bold z-50 whitespace-nowrap shadow-lg">
        Message
    </div>

    <script>
        // State variables
        let words = [];
        let currentIndex = 0;
        let synth = window.speechSynthesis;
        let selectedLang = 'zh-HK'; // Default to Cantonese
        let speakingRate = 0.8;
        let shouldReadPunctuation = false;
        let isSpeaking = false;
        let confirmCallback = null; // Store function to run on confirm

        // Load voices
        function loadVoices() {
            const voices = synth.getVoices();
        }
        loadVoices();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }

        // --- Confirmation Modal Functions ---

        function showConfirm(title, message, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function onConfirmYes() {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        }

        // --- Core Functions ---

        function startDictation() {
            const rawInput = document.getElementById('word-input').value;
            
            // Only split by newline (\n)
            words = rawInput.split(/\n+/).map(w => w.trim()).filter(w => w.length > 0);

            if (words.length === 0) {
                showToast("âš ï¸ è«‹å…ˆè¼¸å…¥ä¸€äº›æ–‡å­—ï¼");
                return;
            }

            // Update State
            currentIndex = 0;
            selectedLang = document.getElementById('language-select').value;
            speakingRate = parseFloat(document.getElementById('speed-range').value);
            shouldReadPunctuation = document.getElementById('read-punctuation').checked;

            // Update UI
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('finished-panel').classList.add('hidden');
            document.getElementById('history-panel').classList.add('hidden');
            document.getElementById('active-panel').classList.remove('hidden');
            
            document.getElementById('total-words').innerText = words.length;
            updateCounter();

            // Speak first word IMMEDIATELY to satisfy mobile browser security policies
            // (Do not use setTimeout here, or mobile browsers will block the audio)
            speakWord(words[currentIndex]);
        }

        function stopDictation() {
            synth.cancel();
            document.getElementById('active-panel').classList.add('hidden');
            document.getElementById('finished-panel').classList.add('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
            isSpeaking = false;
        }

        function nextWord() {
            if (currentIndex < words.length - 1) {
                currentIndex++;
                updateCounter();
                speakWord(words[currentIndex]);
            } else {
                finishSession();
            }
        }

        function repeatWord() {
            speakWord(words[currentIndex]);
        }

        function updateCounter() {
            document.getElementById('word-counter').innerText = currentIndex + 1;
        }

        function speakWord(text) {
            synth.cancel();

            let textToSpeak = text;

            // Punctuation Replacement Logic
            if (shouldReadPunctuation) {
                if (selectedLang === 'zh-HK') {
                    // Cantonese Punctuation Names
                    textToSpeak = textToSpeak
                        .replace(/ã€Š/g, ' å·¦æ›¸åè™Ÿ ')
                        .replace(/ã€‹/g, ' å³æ›¸åè™Ÿ ')
                        .replace(/ã€Œ/g, ' ä¸Šå¼•è™Ÿ ')
                        .replace(/ã€/g, ' ä¸‹å¼•è™Ÿ ')
                        .replace(/ï¼ˆ/g, ' å·¦æ‹¬è™Ÿ ')
                        .replace(/\(/g, ' å·¦æ‹¬è™Ÿ ')
                        .replace(/ï¼‰/g, ' å³æ‹¬è™Ÿ ')
                        .replace(/\)/g, ' å³æ‹¬è™Ÿ ')
                        .replace(/â€œ/g, ' é–‹å¼•è™Ÿ ')
                        .replace(/â€/g, ' é—œå¼•è™Ÿ ')
                        .replace(/ï¼‚/g, ' é›™å¼•è™Ÿ ')
                        .replace(/"/g, ' å¼•è™Ÿ ')
                        .replace(/ã€‚/g, ' å¥è™Ÿ ')
                        .replace(/ï¼Œ/g, ' é€—è™Ÿ ')
                        .replace(/ï¼Ÿ/g, ' å•è™Ÿ ')
                        .replace(/ï¼/g, ' æ„Ÿå˜†è™Ÿ ')
                        .replace(/ï¼›/g, ' åˆ†è™Ÿ ')
                        .replace(/ï¼š/g, ' å†’è™Ÿ ')
                        .replace(/ã€/g, ' é “è™Ÿ ')
                        .replace(/\./g, ' å¥è™Ÿ ')
                        .replace(/,/g, ' é€—è™Ÿ ')
                        .replace(/\?/g, ' å•è™Ÿ ')
                        .replace(/!/g, ' æ„Ÿå˜†è™Ÿ ')
                        .replace(/;/g, ' åˆ†è™Ÿ ')
                        .replace(/:/g, ' å†’è™Ÿ ');
                } else {
                    // English Punctuation Names
                    textToSpeak = textToSpeak
                        .replace(/\./g, ' full stop ')
                        .replace(/,/g, ' comma ')
                        .replace(/\?/g, ' question mark ')
                        .replace(/!/g, ' exclamation mark ')
                        .replace(/;/g, ' semi colon ')
                        .replace(/:/g, ' colon ')
                        .replace(/\(/g, ' left bracket ')
                        .replace(/\)/g, ' right bracket ')
                        .replace(/"/g, ' quote ');
                }
            }

            const utterThis = new SpeechSynthesisUtterance(textToSpeak);
            utterThis.lang = selectedLang;
            
            const voices = synth.getVoices();
            let targetVoice = voices.find(v => v.lang === selectedLang) || 
                              voices.find(v => v.lang.startsWith(selectedLang));
            
            if (!targetVoice && selectedLang === 'zh-HK') {
                targetVoice = voices.find(v => v.lang.includes('zh-HK') || v.lang.includes('yue'));
            }

            if (targetVoice) {
                utterThis.voice = targetVoice;
            }

            utterThis.rate = speakingRate;
            utterThis.pitch = 1;

            const statusEl = document.getElementById('status-text');
            statusEl.innerText = "ğŸ”Š æ­£åœ¨è®€...";
            statusEl.classList.add('text-blue-500');
            
            utterThis.onend = function() {
                statusEl.innerText = "âœï¸ è«‹å¯«ä¸‹ä¾†ï¼";
                statusEl.classList.remove('text-blue-500');
            };

            utterThis.onerror = function(event) {
                console.error("SpeechSynthesis error", event);
                if (event.error !== 'canceled') {
                     showToast("æ’­æ”¾è²éŸ³æ™‚å‡ºéŒ¯");
                }
            };

            synth.speak(utterThis);
        }

        function finishSession() {
            document.getElementById('active-panel').classList.add('hidden');
            document.getElementById('finished-panel').classList.remove('hidden');
            
            saveSessionToHistory();

            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            const utterFinish = new SpeechSynthesisUtterance("åšçš„å¾ˆæ£’ï¼");
            utterFinish.lang = selectedLang.startsWith('zh') ? 'zh-HK' : 'en-US';
            if(selectedLang === 'zh-HK') utterFinish.text = "åšå¾—å¥½ï¼ä½ å®Œæˆå’—å•¦ã€‚";
            if(selectedLang.startsWith('en')) utterFinish.text = "Good Job! You finished.";
            synth.speak(utterFinish);
        }

        // --- History & Utility Functions ---

        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('dictation_history') || '[]');
            } catch (e) { return []; }
        }

        function saveSessionToHistory() {
            const history = getHistory();
            const now = new Date();
            const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const newEntry = {
                id: Date.now(),
                date: dateStr,
                words: words,
                lang: selectedLang
            };
            history.unshift(newEntry);
            if (history.length > 30) history.pop();
            localStorage.setItem('dictation_history', JSON.stringify(history));
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            const history = getHistory();
            
            if (history.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-400 py-12">
                        <div class="text-4xl mb-2">ğŸ“­</div>
                        <div class="font-bold">é‚„æ²’æœ‰ç´€éŒ„</div>
                        <div class="text-sm font-normal">å®Œæˆä¸€æ¬¡è½å¯«å¾Œæœƒè‡ªå‹•å„²å­˜</div>
                    </div>`;
                return;
            }

            list.innerHTML = history.map(item => `
                <div class="history-item bg-blue-50 p-4 rounded-2xl border-2 border-blue-100 flex flex-col gap-2">
                    <div class="flex justify-between items-start border-b border-blue-200 pb-2 mb-1">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-black bg-white px-2 py-1 rounded-lg text-blue-500 border border-blue-100 shadow-sm">
                                ${getLangFlag(item.lang)}
                            </span>
                            <span class="font-bold text-blue-800 text-sm">${item.date}</span>
                        </div>
                        <span class="bg-blue-200 text-blue-800 text-xs font-bold px-2 py-1 rounded-full">
                            ${item.words.length} é¡Œ
                        </span>
                    </div>
                    
                    <div class="text-gray-600 text-sm font-medium line-clamp-2 bg-white/50 p-2 rounded-lg">
                        ${item.words.join(' â€¢ ')}
                    </div>
                    
                    <div class="flex gap-2 mt-1">
                        <button onclick="loadHistoryItem(${item.id})" class="flex-1 bg-green-500 hover:bg-green-600 active:bg-green-700 text-white py-3 rounded-xl font-black shadow-sm flex items-center justify-center gap-2 transition-colors">
                            <span>ğŸ“ è¤‡ç¿’ (Load)</span>
                        </button>
                        <button onclick="deleteHistoryItem(${item.id})" class="w-14 bg-red-100 hover:bg-red-200 text-red-500 active:bg-red-300 py-3 rounded-xl font-black shadow-sm flex items-center justify-center transition-colors border-2 border-transparent hover:border-red-200" title="åˆªé™¤æ­¤ç´€éŒ„">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getLangFlag(lang) {
            if(lang === 'en-US') return 'ğŸ‡ºğŸ‡¸ è‹±æ–‡';
            if(lang === 'en-GB') return 'ğŸ‡¬ğŸ‡§ è‹±æ–‡';
            if(lang === 'zh-HK') return 'ğŸ‡­ğŸ‡° å»£æ±è©±';
            return 'ğŸŒ';
        }

        function loadHistoryItem(id) {
            const history = getHistory();
            const item = history.find(i => i.id === id);
            if (item) {
                document.getElementById('word-input').value = item.words.join('\n');
                document.getElementById('language-select').value = item.lang;
                showSetup();
                showToast("âœ… å·²è¼‰å…¥ç´€éŒ„ï¼æŒ‰ã€Œé–‹å§‹ã€å³å¯ã€‚");
            }
        }

        // New function to handle single item deletion
        function deleteHistoryItem(id) {
            showConfirm(
                "åˆªé™¤ç´€éŒ„ï¼Ÿ", 
                "ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿç„¡æ³•å¾©åŸã€‚", 
                () => {
                    let history = getHistory();
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem('dictation_history', JSON.stringify(history));
                    renderHistory();
                    showToast("ğŸ—‘ï¸ ç´€éŒ„å·²åˆªé™¤");
                }
            );
        }

        function clearHistory() {
            const history = getHistory();
            if(history.length === 0) return;

            showConfirm(
                "æ¸…ç©ºæ­·å²ï¼Ÿ", 
                "ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ", 
                () => {
                    localStorage.removeItem('dictation_history');
                    renderHistory();
                    showToast("ğŸ—‘ï¸ æ­·å²å·²æ¸…ç©º");
                }
            );
        }

        function showHistory() {
            renderHistory();
            document.getElementById('history-panel').classList.remove('hidden');
        }

        function showSetup() {
            document.getElementById('history-panel').classList.add('hidden');
            document.getElementById('active-panel').classList.add('hidden');
            document.getElementById('finished-panel').classList.add('hidden');
            document.getElementById('setup-panel').classList.remove('hidden');
        }

        function clearInput() {
            const input = document.getElementById('word-input');
            if(input.value.trim() === '') return;
            
            showConfirm(
                "æ¸…ç©ºæ–‡å­—ï¼Ÿ", 
                "æ‚¨è¼¸å…¥çš„å…§å®¹å°‡æœƒæ¶ˆå¤±ã€‚", 
                () => {
                    input.value = '';
                    showToast("ğŸ—‘ï¸ å·²æ¸…ç©º");
                }
            );
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
